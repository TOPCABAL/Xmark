<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Twitter账号数据库管理系统</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background-color: #f8f9fa;
      padding-bottom: 50px;
    }
    .header {
      background-color: #1da1f2;
      color: white;
      padding: 20px 0;
      margin-bottom: 30px;
    }
    .card {
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .card-header {
      font-weight: bold;
      background-color: #f0f7ff;
    }
    .stat-card {
      text-align: center;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .stat-card h2 {
      font-size: 2rem;
      font-weight: bold;
      margin: 10px 0;
      color: #1da1f2;
    }
    .stat-card p {
      color: #6c757d;
      margin-bottom: 0;
    }
    .table-container {
      overflow-x: auto;
    }
    .form-label {
      font-weight: 500;
    }
    .alert-results {
      max-height: 300px;
      overflow-y: auto;
    }
    .badge-category {
      font-size: 85%;
      padding: 5px 8px;
      margin: 2px;
      display: inline-block;
    }
  </style>
</head>
<body>
  <!-- 页面头部 -->
  <div class="header">
    <div class="container">
      <h1><i class="bi bi-database"></i> Twitter账号数据库管理系统</h1>
      <p class="lead">用于管理SQLite数据库中的Twitter账号数据</p>
    </div>
  </div>

  <div class="container">
    <!-- 数据库统计 -->
    <div class="row mb-4">
      <div class="col-md-3">
        <div class="stat-card">
          <p>总账号数</p>
          <h2 id="totalAccounts">-</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <p>已标注账号</p>
          <h2 id="annotatedAccounts">-</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <p>未标注账号</p>
          <h2 id="unannotatedAccounts">-</h2>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stat-card">
          <p>分类总数</p>
          <h2 id="totalCategories">-</h2>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- 左侧面板 - 管理功能 -->
      <div class="col-md-4 mb-4">
        <div class="accordion" id="adminAccordion">
          <!-- 数据库管理 -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                数据库基本管理
              </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#adminAccordion">
              <div class="accordion-body">
                <button id="refreshStats" class="btn btn-outline-primary mb-3 w-100">刷新数据统计</button>
                <button id="backupDatabase" class="btn btn-outline-success mb-3 w-100">备份数据库</button>
                <div class="alert alert-info small">
                  备份会在服务器上创建数据库的副本，防止误操作导致数据丢失。
                </div>
              </div>
            </div>
          </div>
          
          <!-- 关注列表管理 -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                关注列表管理
              </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#adminAccordion">
              <div class="accordion-body">
                <div class="mb-3">
                  <label for="importSourceSelect" class="form-label">已导入的关注列表源</label>
                  <select id="importSourceSelect" class="form-select mb-2">
                    <option value="">加载中...</option>
                  </select>
                </div>
                <div class="mb-3">
                  <button id="viewSourceAccounts" class="btn btn-outline-primary mb-2 w-100">查看此源账号</button>
                  <button id="deleteSourceAccounts" class="btn btn-outline-danger w-100">删除此源账号</button>
                </div>
                <div class="alert alert-warning small">
                  删除关注列表将移除从该来源导入的所有Twitter账号数据，此操作不可撤销。
                </div>
              </div>
            </div>
          </div>
          
          <!-- 批量数据管理 -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingThree">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                批量数据管理
              </button>
            </h2>
            <div id="collapseThree" class="accordion-collapse collapse" aria-labelledby="headingThree" data-bs-parent="#adminAccordion">
              <div class="accordion-body">
                <div class="mb-3">
                  <button id="deleteUnannotated" class="btn btn-outline-danger mb-3 w-100">删除所有未标注数据</button>
                  <div class="alert alert-warning small">
                    删除所有未标注数据将移除数据库中所有未添加标注的账号，此操作不可撤销。
                  </div>
                </div>
                <div class="mb-3">
                  <button id="cleanDuplicates" class="btn btn-outline-warning mb-3 w-100">清理重复数据</button>
                  <div class="alert alert-info small">
                    系统将检测并合并可能重复的账号数据。
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- 分类管理 -->
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingFour">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                分类管理
              </button>
            </h2>
            <div id="collapseFour" class="accordion-collapse collapse" aria-labelledby="headingFour" data-bs-parent="#adminAccordion">
              <div class="accordion-body">
                <div class="mb-3">
                  <label class="form-label">分类操作</label>
                  <div class="input-group mb-3">
                    <select id="categorySelect" class="form-select">
                      <option value="">加载中...</option>
                    </select>
                    <button id="viewCategoryAccounts" class="btn btn-outline-primary">查看</button>
                  </div>
                </div>

                <!-- 新增标签管理部分 -->
                <div class="mb-3">
                  <label class="form-label">标签管理</label>
                  <div class="input-group mb-2">
                    <input type="text" id="newTagInput" class="form-control" placeholder="输入新标签名称">
                    <button id="addNewTag" class="btn btn-outline-success">添加</button>
                  </div>
                  <div id="tagsList" class="border rounded p-2 mb-2" style="max-height: 150px; overflow-y: auto;">
                    <div class="text-muted small">加载标签中...</div>
                  </div>
                  <div class="input-group mb-2">
                    <select id="editTagSelect" class="form-select">
                      <option value="">选择要编辑的标签</option>
                    </select>
                    <input type="text" id="editTagInput" class="form-control" placeholder="新标签名称">
                    <button id="editTag" class="btn btn-outline-warning">修改</button>
                    <button id="deleteTag" class="btn btn-outline-danger">删除</button>
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">重命名分类</label>
                  <div class="input-group mb-3">
                    <select id="categoryRenameSource" class="form-select">
                      <option value="">选择分类</option>
                    </select>
                  </div>
                  <div class="input-group mb-3">
                    <input type="text" id="categoryRenameTarget" class="form-control" placeholder="新分类名称">
                    <button id="renameCategory" class="btn btn-outline-warning">重命名</button>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">合并分类</label>
                  <div class="input-group mb-3">
                    <select id="categoryMergeSource" class="form-select">
                      <option value="">选择源分类</option>
                    </select>
                  </div>
                  <div class="input-group mb-3">
                    <select id="categoryMergeTarget" class="form-select">
                      <option value="">选择目标分类</option>
                    </select>
                    <button id="mergeCategories" class="btn btn-outline-warning">合并</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 右侧面板 - 数据表格和结果显示 -->
      <div class="col-md-8">
        <!-- 数据查询 -->
        <div class="card mb-4">
          <div class="card-header">
            数据查询
          </div>
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-4">
                <label for="queryCategory" class="form-label">分类筛选</label>
                <select id="queryCategory" class="form-select">
                  <option value="">全部分类</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="queryAnnotated" class="form-label">标注状态</label>
                <select id="queryAnnotated" class="form-select">
                  <option value="">全部</option>
                  <option value="true">已标注</option>
                  <option value="false">未标注</option>
                </select>
              </div>
              <div class="col-md-4">
                <label for="querySource" class="form-label">导入来源</label>
                <select id="querySource" class="form-select">
                  <option value="">全部来源</option>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="querySearch" class="form-label">搜索关键词</label>
                <input type="text" id="querySearch" class="form-control" placeholder="用户名、名称或备注...">
              </div>
              <div class="col-md-3">
                <label for="queryLimit" class="form-label">每页数量</label>
                <input type="number" id="queryLimit" class="form-control" value="50" min="10" max="500">
              </div>
              <div class="col-md-3">
                <label for="queryOffset" class="form-label">起始位置</label>
                <input type="number" id="queryOffset" class="form-control" value="0" min="0">
              </div>
            </div>
            <div class="row">
              <div class="col-12">
                <button id="runQuery" class="btn btn-primary">执行查询</button>
                <button id="exportQueryResults" class="btn btn-outline-success ms-2">导出查询结果</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 操作结果 -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span>操作结果</span>
            <span id="resultCounter" class="badge bg-primary">0条记录</span>
          </div>
          <div class="card-body p-0">
            <div id="resultsContainer" class="alert-results">
              <div class="alert alert-info m-3">
                请使用左侧功能执行操作，结果将显示在此处。
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 确认对话框 -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmTitle">确认操作</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmMessage">
          您确定要执行此操作吗？
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-danger" id="confirmButton">确认</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // API基础URL
    const API_BASE_URL = (() => {
      const protocol = window.location.protocol;
      const hostname = window.location.hostname;
      const port = '3001';  // API服务器端口
      
      // 如果是本地开发环境
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return `${protocol}//${hostname}:${port}`;
      }
      
      // 生产环境
      return `${protocol}//${hostname}:${port}`;
    })();
    
    // DOM元素
    const elements = {
      // 统计区域
      totalAccounts: document.getElementById('totalAccounts'),
      annotatedAccounts: document.getElementById('annotatedAccounts'),
      unannotatedAccounts: document.getElementById('unannotatedAccounts'),
      totalCategories: document.getElementById('totalCategories'),
      
      // 标签管理
      newTagInput: document.getElementById('newTagInput'),
      addNewTag: document.getElementById('addNewTag'),
      tagsList: document.getElementById('tagsList'),
      editTagSelect: document.getElementById('editTagSelect'),
      editTagInput: document.getElementById('editTagInput'),
      editTag: document.getElementById('editTag'),
      deleteTag: document.getElementById('deleteTag'),
      
      // 关注列表管理
      importSourceSelect: document.getElementById('importSourceSelect'),
      viewSourceAccounts: document.getElementById('viewSourceAccounts'),
      deleteSourceAccounts: document.getElementById('deleteSourceAccounts'),
      
      // 批量管理
      deleteUnannotated: document.getElementById('deleteUnannotated'),
      cleanDuplicates: document.getElementById('cleanDuplicates'),
      
      // 分类管理
      categorySelect: document.getElementById('categorySelect'),
      viewCategoryAccounts: document.getElementById('viewCategoryAccounts'),
      categoryRenameSource: document.getElementById('categoryRenameSource'),
      categoryRenameTarget: document.getElementById('categoryRenameTarget'),
      renameCategory: document.getElementById('renameCategory'),
      categoryMergeSource: document.getElementById('categoryMergeSource'),
      categoryMergeTarget: document.getElementById('categoryMergeTarget'),
      mergeCategories: document.getElementById('mergeCategories'),
      
      // 查询功能
      queryCategory: document.getElementById('queryCategory'),
      queryAnnotated: document.getElementById('queryAnnotated'),
      querySource: document.getElementById('querySource'),
      querySearch: document.getElementById('querySearch'),
      queryLimit: document.getElementById('queryLimit'),
      queryOffset: document.getElementById('queryOffset'),
      runQuery: document.getElementById('runQuery'),
      exportQueryResults: document.getElementById('exportQueryResults'),
      
      // 结果显示
      resultsContainer: document.getElementById('resultsContainer'),
      resultCounter: document.getElementById('resultCounter'),
      
      // 基本功能
      refreshStats: document.getElementById('refreshStats'),
      backupDatabase: document.getElementById('backupDatabase'),
      
      // 确认对话框
      confirmModal: new bootstrap.Modal(document.getElementById('confirmModal')),
      confirmTitle: document.getElementById('confirmTitle'),
      confirmMessage: document.getElementById('confirmMessage'),
      confirmButton: document.getElementById('confirmButton')
    };
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadStats();
      loadImportSources();
      loadCategories();
      loadTags(); // 加载标签列表
      
      // 按钮事件处理
      elements.refreshStats.addEventListener('click', loadStats);
      elements.backupDatabase.addEventListener('click', backupDatabase);
      
      // 标签管理事件处理
      elements.addNewTag.addEventListener('click', addNewTag);
      elements.editTag.addEventListener('click', editTag);
      elements.deleteTag.addEventListener('click', () => showConfirmDialog(
        '删除标签',
        `确定要删除标签"${elements.editTagSelect.value}"吗？此操作不可撤销！`,
        deleteTag
      ));
      
      elements.viewSourceAccounts.addEventListener('click', viewSourceAccounts);
      elements.deleteSourceAccounts.addEventListener('click', () => showConfirmDialog(
        '删除关注列表',
        `确定要删除从 ${elements.importSourceSelect.value} 导入的所有账号吗？此操作不可撤销！`,
        deleteSourceAccounts
      ));
      
      elements.deleteUnannotated.addEventListener('click', () => showConfirmDialog(
        '删除未标注数据',
        '确定要删除所有未标注的账号数据吗？此操作不可撤销！',
        deleteUnannotatedAccounts
      ));
      
      elements.cleanDuplicates.addEventListener('click', cleanDuplicateAccounts);
      
      elements.viewCategoryAccounts.addEventListener('click', viewCategoryAccounts);
      elements.renameCategory.addEventListener('click', renameCategory);
      elements.mergeCategories.addEventListener('click', () => showConfirmDialog(
        '合并分类',
        `确定要将分类"${elements.categoryMergeSource.value}"合并到"${elements.categoryMergeTarget.value}"吗？`,
        mergeCategories
      ));
      
      elements.runQuery.addEventListener('click', runQuery);
      elements.exportQueryResults.addEventListener('click', exportQueryResults);
    });
    
    // API调用函数
    async function callApi(endpoint, options = {}) {
      try {
        showLoading();
        
        const url = `${API_BASE_URL}${endpoint}`;
        console.log(`[API请求] ${options.method || 'GET'} ${url}`);
        
        // 如果没有提供signal，创建一个默认的超时处理
        if (!options.signal) {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 15000);
          options.signal = controller.signal;
          
          // 请求完成后清除超时
          setTimeout(() => clearTimeout(timeoutId), 15500);
        }
        
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            ...options.headers
          },
          mode: 'cors'
        });
        
        if (!response.ok) {
          let errorMessage = `HTTP错误 ${response.status}`;
          try {
            const errorData = await response.json();
            errorMessage = errorData.message || errorData.error || errorMessage;
          } catch (e) {
            try {
              errorMessage = await response.text() || errorMessage;
            } catch (textError) {
              // 如果无法读取响应内容，保持默认错误消息
            }
          }
          throw new Error(errorMessage);
        }
        
        const data = await response.json();
        console.log(`[API响应] ${endpoint}:`, data);
        // 不在这里调用hideLoading，避免覆盖后续的成功或错误消息
        return data;
      } catch (error) {
        console.error(`[API错误] ${endpoint}:`, error);
        
        if (error.name === 'AbortError') {
          showError(`请求超时: ${endpoint}`);
          throw new Error(`请求超时`);
        } else if (error.name === 'SyntaxError') {
          showError(`解析响应失败: 服务器返回了无效的JSON数据`);
          throw new Error(`解析响应失败`);
        } else {
          showError(`请求失败: ${error.message}`);
          throw error;
        }
      } finally {
        hideLoading(); // 确保在任何情况下都隐藏加载状态
      }
    }
    
    // 加载统计信息
    async function loadStats() {
      try {
        const data = await callApi('/api/stats');
        if (data.success) {
          elements.totalAccounts.textContent = data.totalAccounts || 0;
          elements.annotatedAccounts.textContent = data.annotatedAccounts || 0;
          elements.unannotatedAccounts.textContent = (data.totalAccounts - data.annotatedAccounts) || 0;
          elements.totalCategories.textContent = data.totalCategories || 0;
          
          showSuccess('统计数据已更新');
        } else {
          showError('获取统计数据失败');
        }
      } catch (error) {
        console.error('加载统计失败:', error);
      }
    }
    
    // 加载导入来源
    async function loadImportSources() {
      try {
        const data = await callApi('/api/sources');
        if (data.success && Array.isArray(data.sources)) {
          populateSelect(elements.importSourceSelect, data.sources.map(s => ({
            value: s.source_username,
            text: `${s.source_username} (${s.count}个账号)`
          })));
          
          populateSelect(elements.querySource, [
            { value: '', text: '全部来源' },
            ...data.sources.map(s => ({
              value: s.source_username,
              text: `${s.source_username} (${s.count}个账号)`
            }))
          ]);
        } else {
          showError('获取导入来源失败');
        }
      } catch (error) {
        console.error('加载导入来源失败:', error);
      }
    }
    
    // 加载分类列表
    async function loadCategories() {
      try {
        const data = await callApi('/api/categories');
        if (data.success && Array.isArray(data.categories)) {
          const categories = data.categories.map(c => ({
            value: c.name,
            text: `${c.name} (${c.count}个账号)`
          }));
          
          populateSelect(elements.categorySelect, categories);
          populateSelect(elements.categoryRenameSource, categories);
          populateSelect(elements.categoryMergeSource, categories);
          populateSelect(elements.categoryMergeTarget, categories);
          
          populateSelect(elements.queryCategory, [
            { value: '', text: '全部分类' },
            ...categories
          ]);
        } else {
          showError('获取分类列表失败');
        }
      } catch (error) {
        console.error('加载分类失败:', error);
      }
    }
    
    // 填充下拉选择框
    function populateSelect(selectElement, options) {
      if (!selectElement) return;
      
      selectElement.innerHTML = '';
      
      if (options.length === 0) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = '无数据';
        selectElement.appendChild(option);
        return;
      }
      
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        selectElement.appendChild(option);
      });
    }
    
    // 显示确认对话框
    function showConfirmDialog(title, message, confirmCallback) {
      elements.confirmTitle.textContent = title;
      elements.confirmMessage.textContent = message;
      
      // 清除之前的事件监听器
      const newConfirmButton = elements.confirmButton.cloneNode(true);
      elements.confirmButton.parentNode.replaceChild(newConfirmButton, elements.confirmButton);
      elements.confirmButton = newConfirmButton;
      
      // 添加新的事件监听器
      elements.confirmButton.addEventListener('click', () => {
        elements.confirmModal.hide();
        confirmCallback();
      });
      
      elements.confirmModal.show();
    }
    
    // 查看指定来源的账号
    async function viewSourceAccounts() {
      const source = elements.importSourceSelect.value;
      if (!source) {
        showError('请选择导入来源');
        return;
      }
      
      try {
        const data = await callApi(`/api/accounts?imported_from=${encodeURIComponent(source)}&limit=100`);
        if (data.success && Array.isArray(data.accounts)) {
          displayAccountsTable(data.accounts, `${source} 导入的账号`);
        } else {
          showError(`获取 ${source} 的账号列表失败`);
        }
      } catch (error) {
        console.error('查看来源账号失败:', error);
      }
    }
    
    // 删除指定来源的账号
    async function deleteSourceAccounts() {
      const source = elements.importSourceSelect.value;
      if (!source) {
        showError('请选择导入来源');
        return;
      }
      
      try {
        const data = await callApi(`/api/sources/${encodeURIComponent(source)}/delete`, {
          method: 'POST'
        });
        
        if (data.success) {
          showSuccess(`已删除 ${data.count} 个从 ${source} 导入的账号`);
          loadStats();
          loadImportSources();
        } else {
          showError(`删除 ${source} 的账号失败: ${data.message}`);
        }
      } catch (error) {
        console.error('删除来源账号失败:', error);
      }
    }
    
    // 删除所有未标注账号
    async function deleteUnannotatedAccounts() {
      try {
        const data = await callApi('/api/accounts/unannotated/delete', {
          method: 'POST'
        });
        
        if (data.success) {
          showSuccess(`已删除 ${data.count} 个未标注账号`);
          loadStats();
        } else {
          showError(`删除未标注账号失败: ${data.message}`);
        }
      } catch (error) {
        console.error('删除未标注账号失败:', error);
      }
    }
    
    // 清理重复账号
    async function cleanDuplicateAccounts() {
      try {
        const data = await callApi('/api/accounts/duplicates/clean', {
          method: 'POST'
        });
        
        if (data.success) {
          showSuccess(`已清理 ${data.count} 个重复账号`);
          loadStats();
        } else {
          showError(`清理重复账号失败: ${data.message}`);
        }
      } catch (error) {
        console.error('清理重复账号失败:', error);
      }
    }
    
    // 查看分类账号
    async function viewCategoryAccounts() {
      const category = elements.categorySelect.value;
      if (!category) {
        showError('请选择分类');
        return;
      }
      
      try {
        const data = await callApi(`/api/accounts?category=${encodeURIComponent(category)}&limit=100`);
        if (data.success && Array.isArray(data.accounts)) {
          displayAccountsTable(data.accounts, `分类 "${category}" 的账号`);
        } else {
          showError(`获取分类 "${category}" 的账号列表失败`);
        }
      } catch (error) {
        console.error('查看分类账号失败:', error);
      }
    }
    
    // 重命名分类
    async function renameCategory() {
      const sourceCategory = elements.categoryRenameSource.value;
      const targetCategory = elements.categoryRenameTarget.value;
      
      if (!sourceCategory) {
        showError('请选择要重命名的分类');
        return;
      }
      
      if (!targetCategory) {
        showError('请输入新的分类名称');
        return;
      }
      
      try {
        const data = await callApi('/api/categories/rename', {
          method: 'POST',
          body: JSON.stringify({
            sourceCategory,
            targetCategory
          })
        });
        
        if (data.success) {
          showSuccess(`已将分类 "${sourceCategory}" 重命名为 "${targetCategory}"，更新了 ${data.count} 个账号`);
          loadStats();
          loadCategories();
        } else {
          showError(`重命名分类失败: ${data.message}`);
        }
      } catch (error) {
        console.error('重命名分类失败:', error);
      }
    }
    
    // 合并分类
    async function mergeCategories() {
      const sourceCategory = elements.categoryMergeSource.value;
      const targetCategory = elements.categoryMergeTarget.value;
      
      if (!sourceCategory || !targetCategory) {
        showError('请选择源分类和目标分类');
        return;
      }
      
      if (sourceCategory === targetCategory) {
        showError('源分类和目标分类不能相同');
        return;
      }
      
      try {
        const data = await callApi('/api/categories/merge', {
          method: 'POST',
          body: JSON.stringify({
            sourceCategory,
            targetCategory
          })
        });
        
        if (data.success) {
          showSuccess(`已将分类 "${sourceCategory}" 合并到 "${targetCategory}"，更新了 ${data.count} 个账号`);
          loadStats();
          loadCategories();
        } else {
          showError(`合并分类失败: ${data.message}`);
        }
      } catch (error) {
        console.error('合并分类失败:', error);
      }
    }
    
    // 执行数据查询
    async function runQuery() {
      const params = new URLSearchParams();
      
      const category = elements.queryCategory.value;
      const annotated = elements.queryAnnotated.value;
      const source = elements.querySource.value;
      const search = elements.querySearch.value;
      const limit = elements.queryLimit.value;
      const offset = elements.queryOffset.value;
      
      if (category) params.append('category', category);
      if (annotated) params.append('isAnnotated', annotated);
      if (source) params.append('imported_from', source);
      if (search) params.append('search', search);
      if (limit) params.append('limit', limit);
      if (offset) params.append('offset', offset);
      
      try {
        const data = await callApi(`/api/accounts?${params.toString()}`);
        if (data.success && Array.isArray(data.accounts)) {
          displayAccountsTable(data.accounts, '查询结果');
        } else {
          showError('查询账号列表失败');
        }
      } catch (error) {
        console.error('执行查询失败:', error);
      }
    }
    
    // 导出查询结果
    async function exportQueryResults() {
      const params = new URLSearchParams();
      
      const category = elements.queryCategory.value;
      const annotated = elements.queryAnnotated.value;
      const source = elements.querySource.value;
      const search = elements.querySearch.value;
      
      params.append('format', 'json'); // 默认导出JSON格式
      
      if (category) params.append('category', category);
      if (annotated) params.append('isAnnotated', annotated);
      if (source) params.append('imported_from', source);
      if (search) params.append('search', search);
      
      try {
        const data = await callApi(`/api/export?${params.toString()}`);
        if (data.success) {
          // 创建下载链接
          const downloadLink = document.createElement('a');
          downloadLink.href = `${API_BASE_URL}${data.downloadUrl}`;
          downloadLink.target = '_blank';
          downloadLink.click();
          
          showSuccess(`已导出 ${data.count} 个账号数据到 ${data.filename}`);
        } else {
          showError('导出数据失败');
        }
      } catch (error) {
        console.error('导出查询结果失败:', error);
      }
    }
    
    // 备份数据库
    async function backupDatabase() {
      try {
        const data = await callApi('/api/database/backup', {
          method: 'POST'
        });
        
        if (data.success) {
          showSuccess(`数据库备份成功: ${data.filename}`);
        } else {
          showError(`数据库备份失败: ${data.message}`);
        }
      } catch (error) {
        console.error('数据库备份失败:', error);
      }
    }
    
    // 显示账号表格
    function displayAccountsTable(accounts, title) {
      if (!accounts || accounts.length === 0) {
        elements.resultsContainer.innerHTML = `
          <div class="alert alert-warning m-3">
            ${title || '查询'} 未找到匹配的账号
          </div>
        `;
        elements.resultCounter.textContent = '0条记录';
        return;
      }
      
      elements.resultCounter.textContent = `${accounts.length}条记录`;
      
      let tableHtml = `
        <div class="table-container">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th>用户名</th>
                <th>名称</th>
                <th>分类</th>
                <th>粉丝数</th>
                <th>标注时间</th>
                <th>导入来源</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      accounts.forEach(account => {
        const username = account.username.replace(/^@/, '');
        const annotatedDate = account.annotated_at 
          ? new Date(account.annotated_at).toLocaleString() 
          : '-';
        
        tableHtml += `
          <tr>
            <td>
              <a href="https://x.com/${username}" target="_blank">@${username}</a>
            </td>
            <td>${account.name || '-'}</td>
            <td>${account.category ? `<span class="badge bg-info badge-category">${account.category}</span>` : '-'}</td>
            <td>${account.followers_count || 0}</td>
            <td>${annotatedDate}</td>
            <td>${account.imported_from || '-'}</td>
          </tr>
        `;
      });
      
      tableHtml += `
            </tbody>
          </table>
        </div>
      `;
      
      elements.resultsContainer.innerHTML = tableHtml;
    }
    
    // 显示成功信息
    function showSuccess(message) {
      elements.resultsContainer.innerHTML = `
        <div class="alert alert-success m-3">
          ${message}
        </div>
      `;
    }
    
    // 显示错误信息
    function showError(message) {
      elements.resultsContainer.innerHTML = `
        <div class="alert alert-danger m-3">
          ${message}
        </div>
      `;
    }
    
    // 显示加载状态
    function showLoading() {
      elements.resultsContainer.innerHTML = `
        <div class="alert alert-info m-3 text-center">
          <div class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          正在处理请求...
        </div>
      `;
    }
    
    // 隐藏加载状态
    function hideLoading() {
      // 仅当当前显示的是加载状态时才清除它
      // 这样可以避免覆盖已经显示的成功或错误消息
      const loadingMessage = elements.resultsContainer.querySelector('.alert-info');
      if (loadingMessage && loadingMessage.textContent.includes('正在处理请求')) {
        // 不要自动替换为默认信息，因为这可能覆盖即将显示的成功消息
        // 只有在没有其他显示消息的情况下才显示默认信息
        const successMessage = elements.resultsContainer.querySelector('.alert-success');
        const errorMessage = elements.resultsContainer.querySelector('.alert-danger');
        
        if (!successMessage && !errorMessage) {
          elements.resultsContainer.innerHTML = `
            <div class="alert alert-info m-3">
              请使用左侧功能执行操作，结果将显示在此处。
            </div>
          `;
        }
      }
    }

    // 加载标签列表
    async function loadTags() {
      try {
        const data = await callApi('/api/categories');
        if (data.success && Array.isArray(data.categories)) {
          // 更新标签列表显示
          updateTagsList(data.categories);
          // 更新编辑下拉框
          populateSelect(elements.editTagSelect, [
            { value: '', text: '选择要编辑的标签' },
            ...data.categories.map(tag => ({
              value: tag.name,
              text: `${tag.name} (${tag.count || 0})`
            }))
          ]);
          // 更新其他相关的下拉框
          populateSelect(elements.categorySelect, data.categories.map(c => ({
            value: c.name,
            text: `${c.name} (${c.count || 0})`
          })));
          populateSelect(elements.categoryRenameSource, data.categories.map(c => ({
            value: c.name,
            text: `${c.name} (${c.count || 0})`
          })));
          populateSelect(elements.categoryMergeSource, data.categories.map(c => ({
            value: c.name,
            text: `${c.name} (${c.count || 0})`
          })));
          populateSelect(elements.categoryMergeTarget, data.categories.map(c => ({
            value: c.name,
            text: `${c.name} (${c.count || 0})`
          })));
          populateSelect(elements.queryCategory, [
            { value: '', text: '全部分类' },
            ...data.categories.map(c => ({
              value: c.name,
              text: `${c.name} (${c.count || 0})`
            }))
          ]);
        } else {
          showError('获取标签列表失败');
        }
      } catch (error) {
        console.error('加载标签失败:', error);
      }
    }

    // 更新标签列表显示
    function updateTagsList(tags) {
      if (!tags || tags.length === 0) {
        elements.tagsList.innerHTML = '<div class="text-muted small">暂无标签</div>';
        return;
      }

      const tagsHtml = tags.map(tag => `
        <span class="badge bg-info me-2 mb-2" style="font-size: 0.9em;">
          ${tag.name}
          <span class="badge bg-secondary ms-1">${tag.count || 0}</span>
        </span>
      `).join('');

      elements.tagsList.innerHTML = tagsHtml;
    }

    // 添加新标签
    async function addNewTag() {
      const newTagName = elements.newTagInput.value.trim();
      if (!newTagName) {
        showError('请输入标签名称');
        return;
      }

      try {
        console.log(`[添加标签] 正在添加新标签: ${newTagName}`);
        
        // 确保使用正确的API端点 - /api/categories/add
        const data = await callApi('/api/categories/add', {
          method: 'POST',
          body: JSON.stringify({ name: newTagName })
        });

        if (data.success) {
          showSuccess(data.message || `成功添加标签"${newTagName}"`);
          elements.newTagInput.value = '';
          console.log(`[添加标签] 刷新数据开始`);
          await loadTags();  // 重新加载所有标签
          await loadStats(); // 更新统计信息 
          console.log(`[添加标签] 刷新数据完成`);
        } else {
          showError(data.message || `添加标签失败`);
        }
      } catch (error) {
        console.error('添加标签失败:', error);
        showError(`添加标签失败: ${error.message || '未知错误'}`);
      }
    }

    // 编辑标签
    async function editTag() {
      const oldTagName = elements.editTagSelect.value;
      const newTagName = elements.editTagInput.value.trim();

      if (!oldTagName || !newTagName) {
        showError('请选择要编辑的标签并输入新的标签名称');
        return;
      }

      try {
        console.log(`[编辑标签] 正在将标签 "${oldTagName}" 重命名为 "${newTagName}"`);
        
        // 确保使用正确的API端点 - /api/categories/rename
        const data = await callApi('/api/categories/rename', {
          method: 'POST',
          body: JSON.stringify({
            sourceCategory: oldTagName,
            targetCategory: newTagName
          })
        });

        if (data.success) {
          showSuccess(data.message || `成功将标签"${oldTagName}"修改为"${newTagName}"`);
          elements.editTagInput.value = '';
          console.log(`[编辑标签] 刷新数据开始`);
          await loadTags();  // 重新加载所有标签
          await loadStats(); // 更新统计信息
          console.log(`[编辑标签] 刷新数据完成`);
        } else {
          showError(data.message || `编辑标签失败`);
        }
      } catch (error) {
        console.error('编辑标签失败:', error);
        showError(`编辑标签失败: ${error.message || '未知错误'}`);
      }
    }

    // 删除标签
    async function deleteTag() {
      const tagName = elements.editTagSelect.value;
      if (!tagName) {
        showError('请选择要删除的标签');
        return;
      }

      try {
        // 添加超时处理
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        console.log(`[删除标签] 正在删除标签: ${tagName}`);
        
        // 确保使用正确的API端点 - /api/categories/delete 而不是 /api/tags/delete
        const data = await callApi('/api/categories/delete', {
          method: 'POST',
          body: JSON.stringify({ name: tagName }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (data.success) {
          // 先显示成功消息
          const successMessage = data.message || `成功删除标签"${tagName}"`;
          showSuccess(successMessage);
          
          // 强制刷新所有标签相关数据
          try {
            console.log(`[删除标签] 刷新数据开始`);
            await loadTags();
            await loadStats();
            await loadCategories();
            console.log(`[删除标签] 刷新数据完成`);
            
            // 刷新完成后再次显示成功消息，确保它不会被覆盖
            showSuccess(successMessage);
          } catch (refreshError) {
            console.error('刷新数据失败:', refreshError);
            // 确保即使刷新失败也显示成功消息
            showSuccess(`标签"${tagName}"已删除，但刷新数据失败: ${refreshError.message}`);
          }
        } else {
          showError(data.message || `删除标签失败`);
        }
      } catch (error) {
        console.error('删除标签失败:', error);
        
        if (error.name === 'AbortError') {
          showError(`删除标签请求超时，但操作可能已成功。正在刷新数据...`);
          
          // 即使请求超时，仍然尝试刷新数据
          try {
            await loadTags();
            await loadStats();
            await loadCategories();
          } catch (refreshError) {
            console.error('刷新数据失败:', refreshError);
          }
        } else {
          showError(`删除标签失败: ${error.message || '未知错误'}`);
        }
      } finally {
        // 确保无论如何都清除加载状态
        hideLoading();
      }
    }
  </script>
</body>
</html> 